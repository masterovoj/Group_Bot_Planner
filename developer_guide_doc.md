# Руководство разработчика Telegram-бота для задач

## Содержание
- [Глава 1. Структура бота](#глава-1-структура-бота)
  - [Структура базы данных](#структура-базы-данных)
  - [Структура кода](#структура-кода)
- [Глава 2. Описание классов, машин состояний, методов](#глава-2-описание-классов-машин-состояний-методов)
- [Глава 3. Принцип работы бота](#глава-3-принцип-работы-бота)
  - [Режим пользователя](#режим-пользователя)
  - [Режим администратора](#режим-администратора)
  - [Режим оповещений](#режим-оповещений)

---

# Глава 1. Структура бота

## Структура базы данных

### Таблица users_tbl
- **user_id**: int, идентификатор пользователя Telegram
- **chat_id**: int, идентификатор группы
- **username**: str, username пользователя
- **full_name**: str, имя пользователя
- **status**: str, статус в группе (administrator, member и др.)
- **first_seen**: datetime, дата первого появления
- **last_seen**: datetime, дата последнего появления

**Назначение:** Хранение информации о пользователях в группах.

### Таблица tasks_tbl
- **id**: int, идентификатор задачи
- **user_id**: int, идентификатор пользователя-исполнителя
- **chat_id**: int, идентификатор группы
- **start_datetime**: datetime, дата и время начала задачи
- **end_datetime**: datetime, дата и время окончания задачи
- **description**: str, описание задачи
- **is_completed**: bool, выполнена ли задача

**Назначение:** Хранение задач, назначенных пользователям в группах.

---

## Структура кода

- **main.py** — основной файл бота, содержит всю бизнес-логику, обработчики, FSM, работу с БД.
- **requirements.txt** — зависимости проекта.
- **tasks_main.db** — база данных SQLite.
- **.env** - файл переменных окружения. В строке TOKEN=YOUR_TOKEN, замените YOUR_TOKEN на токен вашего бота. Без пробелов и скобок, как написано.

### Основные классы и сущности
- **User** — ORM-модель пользователя.
- **Task** — ORM-модель задачи.
- **SimpleCalendar, SimpleCalendarCallback** — inline-календарь для выбора дат.
- **FSM (машины состояний):**
  - TaskCreation — создание задачи
  - AdminViewTasks — просмотр задач пользователя админом
  - TaskStates — редактирование задачи
  - AdminSendMessageFSM — отправка сообщения пользователю по задаче

### Основные методы и обработчики
- **format_task_message** — форматирует задачу и создает inline-клавиатуру
- **show_my_tasks_pm** — просмотр задач пользователя
- **admin_choose_user_for_view, admin_view_selected_user_tasks** — просмотр задач пользователя админом
- **new_task_start_pm, new_task_user_selected, ...** — FSM создания задачи
- **edit_task_handler, process_edit_description, ...** — FSM редактирования задачи
- **admin_sendmsg_start, admin_sendmsg_process** — FSM отправки сообщения по задаче
- **check_overdue_tasks, notify_task_deadlines** — фоновое оповещение о просроченных задачах

---

# Глава 2. Описание классов, машин состояний, методов

## Классы
- **User** — описывает пользователя, связан с задачами (tasks)
- **Task** — описывает задачу, связан с пользователем (user)
- **SimpleCalendar, SimpleCalendarCallback** — реализуют inline-календарь для выбора дат

## FSM (машины состояний)
- **TaskCreation**
  - waiting_for_user — выбор исполнителя
  - waiting_for_start_date — выбор даты начала
  - waiting_for_start_time — ввод времени начала
  - waiting_for_end_date — выбор даты окончания
  - waiting_for_end_time — ввод времени окончания
  - waiting_for_description — ввод описания
  - waiting_for_confirmation — подтверждение
- **AdminViewTasks**
  - waiting_for_user — выбор пользователя для просмотра задач
  - viewing_tasks — просмотр задач выбранного пользователя
- **TaskStates**
  - editing_task_description — редактирование описания
  - editing_task_end_date — редактирование даты окончания
  - editing_task_end_time — редактирование времени окончания
- **AdminSendMessageFSM**
  - waiting_for_text — ожидание текста сообщения для пользователя

## Основные методы
- **format_task_message(task, for_admin)** — формирует текст задачи и inline-кнопки
- **show_my_tasks_pm** — показывает задачи пользователя
- **admin_choose_user_for_view** — инициирует выбор пользователя для просмотра задач
- **admin_view_selected_user_tasks** — показывает задачи выбранного пользователя
- **new_task_start_pm** — начало создания задачи
- **new_task_user_selected** — выбор исполнителя
- **process_calendar_for_creation** — обработка inline-календаря
- **new_task_start_time, new_task_end_time, new_task_description** — ввод времени и описания
- **new_task_confirm** — подтверждение создания задачи
- **edit_task_handler, process_edit_description, process_edit_date, process_edit_end_time** — редактирование задачи
- **admin_sendmsg_start, admin_sendmsg_process** — отправка сообщения пользователю по задаче
- **check_overdue_tasks, notify_task_deadlines** — фоновое оповещение о просроченных задачах

---

# Глава 3. Принцип работы бота

## Режим пользователя
- Пользователь запускает бота через /start в личке.
- Получает список своих задач, может отмечать их выполненными, редактировать описание и сроки.
- Получает личные уведомления о новых задачах и сообщениях от администратора.

## Режим администратора
- Администратор выбирает группу через /admin (в группе).
- Может создавать задачи для любого пользователя из списка.
- Может просматривать задачи любого пользователя (выбор из списка).
- Может редактировать и удалять задачи любого пользователя.
- Может отправить личное сообщение пользователю по конкретной задаче (с цитатой задачи и подписью).

## Режим оповещений
- Бот периодически проверяет задачи на просрочку.
- Если задача просрочена и не выполнена, бот отправляет уведомление в групповой чат с упоминанием пользователя.
- Все уведомления и сообщения формируются автоматически, с учётом ролей и контекста. 